import styles from 'data-text:./components/content/content.module.css'
import type { PlasmoCSConfig } from 'plasmo'
import { useEffect, useState } from 'react'
import TurndownService from 'turndown'

import { ACTIONS, BACKGROUND_EVENTS } from '~/common/action'
import { prepareContent } from '~/common/prepare-content'
import type { MsgRes } from '~/common/types'

import { DraggableBox } from './components/content/draggableBox'
import { StartSelectEnum } from './components/content/helper'
import { initSelectArea } from './components/content/selector'

export const getStyle = () => {
  const style = document.createElement('style')
  style.textContent = styles

  return style
}

export const config: PlasmoCSConfig = {
  matches: ['<all_urls>'],
}

const PlasmoOverlay = () => {
  const [isOpen, setIsOpen] = useState<boolean>(false)
  const [inputValue, setInputValue] = useState<string>('')

  // Á´ãÂç≥Ê£ÄÊü•È°µÈù¢‰∏äÁöÑËæìÂÖ•Ê°Ü
  console.log('üöÄ Content script loaded, checking for inputs immediately...')
  console.log('Current URL:', window.location.href)
  console.log('üîß Plugin is working!')
  
  // Á´ãÂç≥ÊâßË°å‰∏ÄÊ¨°Ê£ÄÊü•
  setTimeout(() => {
    console.log('üîç Immediate check after 1 second...')
    const allInputs = document.querySelectorAll('input')
    console.log(`Found ${allInputs.length} total inputs on page`)
    
    allInputs.forEach((input, index) => {
      const htmlInput = input as HTMLInputElement
      console.log(`Input ${index}:`, {
        tagName: htmlInput.tagName,
        type: htmlInput.type,
        className: htmlInput.className,
        value: htmlInput.value,
        placeholder: htmlInput.placeholder,
        inputmode: htmlInput.inputMode,
        autocomplete: htmlInput.autocomplete,
        outerHTML: htmlInput.outerHTML.substring(0, 200) + '...'
      })
    })
  }, 1000)

  // ÁõëÂê¨ Polymarket ËæìÂÖ•Ê°ÜÂÄºÂèòÂåñ
  /*
  useEffect(() => {
    const handleInputChange = (event: Event) => {
      const target = event.target as HTMLInputElement
      console.log('Input event detected:', target, target.className, target.value)
      
      // Êõ¥ÂÆΩÊ≥õÁöÑÈÄâÊã©Âô®ÂåπÈÖç
      if (target && target.matches('input[inputmode="decimal"]')) {
        const value = target.value
        setInputValue(value)
        console.log('Polymarket input value changed:', value)
        
        // ‰∏ªÂä®ÂèëÈÄÅÁªô popup
        chrome.runtime.sendMessage({
          type: BACKGROUND_EVENTS.GetPageContent,
          payload: { value }
        }).catch(err => console.warn('Failed to send input value to popup:', err))
      }
    }

    const handleKeyUp = (event: KeyboardEvent) => {
      const target = event.target as HTMLInputElement
      console.log('Keyup event detected:', target, target.className, target.value)
      
      if (target && target.matches('input[inputmode="decimal"]')) {
        const value = target.value
        setInputValue(value)
        console.log('Polymarket input value changed (keyup):', value)
        
        chrome.runtime.sendMessage({
          type: BACKGROUND_EVENTS.GetPageContent,
          payload: { value }
        }).catch(err => console.warn('Failed to send input value to popup:', err))
      }
    }

    // ÁõëÂê¨ÊâÄÊúâËæìÂÖ•‰∫ã‰ª∂
    document.addEventListener('input', handleInputChange)
    document.addEventListener('change', handleInputChange)
    document.addEventListener('keyup', handleKeyUp)
    document.addEventListener('keydown', handleKeyUp)

    // ÂÆöÊúüÊ£ÄÊü•ËæìÂÖ•Ê°ÜÂÄºÔºàÂ§ÑÁêÜÂä®ÊÄÅÂÜÖÂÆπÔºâ
    const checkInputs = () => {
      console.log('=== ÂºÄÂßãÊ£ÄÊü•ËæìÂÖ•Ê°Ü ===')
      
      // Â∞ùËØïÂ§öÁßçÈÄâÊã©Âô®
      const selectors = [
        'input[inputmode="decimal"]',
        'input[type="text"][inputmode="decimal"]',
        'input.c-fPFMNh', // Ê†πÊçÆ‰Ω†Êèê‰æõÁöÑclass
        'input[placeholder="0"]',
        'input[autocomplete="off"][inputmode="decimal"]',
        'input[type="text"]', // ÊâÄÊúâÊñáÊú¨ËæìÂÖ•Ê°Ü
        'input' // ÊâÄÊúâËæìÂÖ•Ê°Ü
      ]
      
      // Ê£ÄÊü•ÊØè‰∏™ÈÄâÊã©Âô®
      selectors.forEach(selector => {
        const inputs = document.querySelectorAll(selector)
        console.log(`üîç Selector "${selector}" found ${inputs.length} inputs`)
        
        if (inputs.length > 0) {
          inputs.forEach((input, index) => {
            const htmlInput = input as HTMLInputElement
            console.log(`  üìù Input ${index} (${selector}):`, {
              element: htmlInput,
              outerHTML: htmlInput.outerHTML,
              value: htmlInput.value,
              className: htmlInput.className,
              placeholder: htmlInput.placeholder,
              inputmode: htmlInput.inputMode,
              type: htmlInput.type,
              autocomplete: htmlInput.autocomplete,
              style: htmlInput.style.cssText,
              parentElement: htmlInput.parentElement?.outerHTML,
              isVisible: htmlInput.offsetWidth > 0 && htmlInput.offsetHeight > 0,
              isDisabled: htmlInput.disabled,
              isReadOnly: htmlInput.readOnly
            })
          })
        }
      })
      
      // Ëé∑ÂèñÊâÄÊúâËæìÂÖ•Ê°Ü
      const allInputs: NodeListOf<HTMLInputElement> = document.querySelectorAll('input')
      console.log(`üìä Total inputs found: ${allInputs.length}`)
      
      // ËØ¶ÁªÜÊ£ÄÊü•ÊØè‰∏™ËæìÂÖ•Ê°Ü
      allInputs.forEach((input, index) => {
        const htmlInput = input as HTMLInputElement
        console.log(`üîç Input ${index} ËØ¶ÁªÜ‰ø°ÊÅØ:`, {
          element: htmlInput,
          outerHTML: htmlInput.outerHTML,
          value: htmlInput.value,
          className: htmlInput.className,
          placeholder: htmlInput.placeholder,
          inputmode: htmlInput.inputMode,
          type: htmlInput.type,
          autocomplete: htmlInput.autocomplete,
          style: htmlInput.style.cssText,
          parentElement: htmlInput.parentElement?.outerHTML,
          grandParentElement: htmlInput.parentElement?.parentElement?.outerHTML,
          isVisible: htmlInput.offsetWidth > 0 && htmlInput.offsetHeight > 0,
          isDisabled: htmlInput.disabled,
          isReadOnly: htmlInput.readOnly,
          computedStyle: window.getComputedStyle(htmlInput),
          boundingRect: htmlInput.getBoundingClientRect()
        })
        
        // Ê£ÄÊü•ÊòØÂê¶ÊòØPolymarketÁöÑËæìÂÖ•Ê°Ü
        const isPolymarketInput = htmlInput.matches('input[inputmode="decimal"]') ||
                                 htmlInput.className.includes('c-fPFMNh') ||
                                 (htmlInput.placeholder === '0' && htmlInput.type === 'text') ||
                                 htmlInput.className.includes('c-fPFMNh')
        
        console.log(`üéØ Input ${index} ÊòØÂê¶ÂåπÈÖçPolymarket: ${isPolymarketInput}`)
        
        if (isPolymarketInput) {
          console.log(`‚úÖ ÊâæÂà∞PolymarketËæìÂÖ•Ê°Ü! ÂÄº: "${htmlInput.value}"`)
          
          if (htmlInput.value && htmlInput.value !== inputValue) {
            setInputValue(htmlInput.value)
            console.log('üîÑ Êõ¥Êñ∞ËæìÂÖ•ÂÄº:', htmlInput.value)
            
            chrome.runtime.sendMessage({
              type: BACKGROUND_EVENTS.GetPageContent,
              payload: { value: htmlInput.value }
            }).catch(err => console.warn('Failed to send input value to popup:', err))
          }
        }
      })
      
      console.log('=== Ê£ÄÊü•ÂÆåÊàê ===')
    }

    // Á´ãÂç≥Ê£ÄÊü•‰∏ÄÊ¨°
    checkInputs()
    
    // ÊØè2ÁßíÊ£ÄÊü•‰∏ÄÊ¨°
    const interval = setInterval(checkInputs, 2000) as NodeJS.Timeout
    
    // Â∞ÜÊ£ÄÊü•ÂáΩÊï∞Êö¥Èú≤Âà∞ÂÖ®Â±ÄÔºåÊñπ‰æøÊâãÂä®Ë∞ÉËØï
    ;(window as any).debugPolymarketInputs = checkInputs
    
    // Ê∑ªÂä†‰∏Ä‰∏™ÁÆÄÂçïÁöÑÊµãËØïÂáΩÊï∞
    ;(window as any).testInputs = () => {
      console.log('üß™ ÁÆÄÂçïÊµãËØïÂáΩÊï∞')
      const inputs = document.querySelectorAll('input')
      console.log(`ÊâæÂà∞ ${inputs.length} ‰∏™ËæìÂÖ•Ê°Ü`)
      
      inputs.forEach((input, i) => {
        const inp = input as HTMLInputElement
        console.log(`ËæìÂÖ•Ê°Ü ${i}:`, {
          value: inp.value,
          class: inp.className,
          type: inp.type,
          placeholder: inp.placeholder,
          inputmode: inp.inputMode
        })
      })
    }
    
    console.log('üîß Ë∞ÉËØïÂáΩÊï∞Â∑≤Êö¥Èú≤:')
    console.log('  - window.debugPolymarketInputs() - ËØ¶ÁªÜÊ£ÄÊü•')
    console.log('  - window.testInputs() - ÁÆÄÂçïÊµãËØï')

    return () => {
      document.removeEventListener('input', handleInputChange)
      document.removeEventListener('change', handleInputChange)
      document.removeEventListener('keyup', handleKeyUp)
      document.removeEventListener('keydown', handleKeyUp)
      clearInterval(interval)
    }
  }, [inputValue])
  */

  useEffect(() => {
    chrome.runtime.onMessage.addListener(
      (
        request: MsgRes<keyof typeof BACKGROUND_EVENTS | keyof typeof ACTIONS, any>,
        sender,
        sendResponse,
      ) => {
        console.log('%c=contentjs onMessage:', 'color:red', request)
        if (request.type === BACKGROUND_EVENTS.GetPageContent) {
          prepareContent()
            .then((document) => {
              sendResponse({ document })
            })
            .catch((error) => {
              console.log('prepare error', error)
            })
        } else if (request.type === BACKGROUND_EVENTS.EndOfGetPageContent) {
          const turndownService = new TurndownService()

          const markdownContent = turndownService.turndown(
            request.payload.content,
          )

          console.log(
            '%c=contentjs onMessage EndOfGetPageContent parse markdownwn results:',
            'color:yellow',
            { markdownContent },
          )
        } else if (request.type === ACTIONS.EnterManually) {
          setIsOpen(true)
        } else if (request.type === ACTIONS.AreaSelect) {
          initSelectArea({ type: request.payload.action as StartSelectEnum })
        } else if (request.type === ACTIONS.QueryInput) {
          // Â§ÑÁêÜ popup ÁöÑÊü•ËØ¢ËØ∑Ê±Ç
          console.log('üîç Êî∂Âà∞ QUERY_INPUT ËØ∑Ê±ÇÔºåÂºÄÂßãÊ£ÄÊü•DOM...')
          
          // Á´ãÂç≥Ê£ÄÊü•ÊâÄÊúâËæìÂÖ•Ê°Ü
          const allInputs = document.querySelectorAll('input')
          console.log(`üìä ÊâæÂà∞ ${allInputs.length} ‰∏™ËæìÂÖ•Ê°Ü`)
          
          let foundValue = inputValue // ÈªòËÆ§‰ΩøÁî®ÂΩìÂâçÁä∂ÊÄÅÂÄº
          
          allInputs.forEach((input, index) => {
            const htmlInput = input as HTMLInputElement
            console.log(`üîç Ê£ÄÊü•ËæìÂÖ•Ê°Ü ${index}:`, {
              value: htmlInput.value,
              className: htmlInput.className,
              type: htmlInput.type,
              placeholder: htmlInput.placeholder,
              inputmode: htmlInput.inputMode,
              outerHTML: htmlInput.outerHTML.substring(0, 100) + '...'
            })
            
            // Ê£ÄÊü•ÊòØÂê¶ÊòØPolymarketÁöÑËæìÂÖ•Ê°Ü
            const isPolymarketInput = htmlInput.matches('input[inputmode="decimal"]') ||
                                     htmlInput.className.includes('c-fPFMNh') ||
                                     (htmlInput.placeholder === '0' && htmlInput.type === 'text')
            
            if (isPolymarketInput && htmlInput.value) {
              foundValue = htmlInput.value
              console.log(`‚úÖ ÊâæÂà∞PolymarketËæìÂÖ•Ê°Ü! ÂÄº: "${htmlInput.value}"`)
            }
          })
          
          console.log(`üì§ ËøîÂõûËæìÂÖ•ÂÄº: "${foundValue}"`)
          sendResponse({ value: foundValue })
        }

        return true
      },
    )
  }, [inputValue])

  useEffect(() => {
    const handleShortcut = (event: KeyboardEvent) => {
      if (event.ctrlKey && event.shiftKey && event.keyCode === 75) {
        setIsOpen(!isOpen)
      }
    }

    document.addEventListener('keydown', handleShortcut)

    return () => {
      document.removeEventListener('keydown', handleShortcut)
    }
  }, [isOpen])

  const onClose = () => {
    setIsOpen(false)
  }

  return (
    <>
      <DraggableBox isOpen={isOpen} onClose={onClose} />
    </>
  )
}

export default PlasmoOverlay
